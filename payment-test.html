<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Tester ‚Äî Sepay & PayOS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #333;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input[type="text"],
        input[type="number"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            margin-top: 30px;
            padding: 20px;
            border-radius: 8px;
            display: none;
        }

        .status.show {
            display: block;
        }

        .status.loading {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }

        .status.success {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
        }

        .status.error {
            background: #ffebee;
            border-left: 4px solid #f44336;
        }

        .status h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .status-text {
            color: #666;
            font-size: 14px;
            margin-bottom: 12px;
            line-height: 1.6;
        }

        .info-box {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 13px;
            font-family: 'Courier New', monospace;
            word-break: break-all;
            color: #333;
        }

        .label-info {
            color: #666;
            font-size: 12px;
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-secondary {
            background: #666;
            padding: 10px 16px;
            font-size: 14px;
            flex: 1;
        }

        .btn-secondary:hover {
            box-shadow: 0 10px 20px rgba(102, 102, 102, 0.4);
        }

        .btn-link {
            background: #667eea;
            padding: 10px 16px;
            font-size: 14px;
            text-decoration: none;
            text-align: center;
            display: inline-block;
            flex: 1;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .transactions {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #e0e0e0;
        }

        .transactions h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .transaction-item {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .transaction-id {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            font-family: monospace;
        }

        .transaction-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .transaction-status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .transaction-status.completed {
            background: #d4edda;
            color: #155724;
        }

        .transaction-status.failed {
            background: #f8d7da;
            color: #721c24;
        }

        .transaction-status.cancelled {
            background: #e2e3e5;
            color: #383d41;
        }

        .transaction-status.refunded {
            background: #d1ecf1;
            color: #0c5460;
        }

        .transaction-info {
            font-size: 13px;
            color: #666;
            margin: 5px 0;
        }

        .info-tag {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 8px;
            margin-top: 8px;
        }

        .error-message {
            color: #f44336;
            font-weight: 500;
        }

        .success-message {
            color: #4caf50;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üí≥ Payment Tester ‚Äî Sepay & PayOS</h1>
        <p class="subtitle">Test flow thanh to√°n Payment Gateway</p>

        <div class="form-group">
            <label for="apiUrl">API Base URL</label>
            <input type="text" id="apiUrl" value="http://localhost:8080/api/payments" placeholder="http://localhost:8080/api/payments">
        </div>

        <div class="form-group">
            <label for="token">JWT Token</label>
            <input type="text" id="token" placeholder="Paste your JWT token here", value="eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJ0djAxSjZEdDdXc1ltNGFlUFhkcWJxMkdIYWotNU5mMXBRRmMtS3UyNDlnIn0.eyJleHAiOjE3ODY0MDQyMjMsImlhdCI6MTc3MDg1MjIyMywianRpIjoiNWE2YTU4ZTItMDdhMy00NWNkLWI2ZDEtMzZiMGE4OTgwMzliIiwiaXNzIjoiaHR0cDovL2xvY2FsaG9zdDo4MDgyL3JlYWxtcy9haS1wcmltYXJ5LWRldiIsImF1ZCI6ImFjY291bnQiLCJzdWIiOiIyODlmZjdhOC0xOGJmLTRmZDEtODBlNy1iYTgyMjhjZTNkNjYiLCJ0eXAiOiJCZWFyZXIiLCJhenAiOiJhaS1wcmltYXJ5Iiwic2Vzc2lvbl9zdGF0ZSI6IjgwYWExOWIxLWNiYjYtNDlkYS1iNTY2LTc2YzRmMDFmMjc2MyIsImFjciI6IjEiLCJhbGxvd2VkLW9yaWdpbnMiOlsiKiJdLCJyZWFsbV9hY2Nlc3MiOnsicm9sZXMiOlsib2ZmbGluZV9hY2Nlc3MiLCJkZWZhdWx0LXJvbGVzLWFpLXByaW1hcnktZGV2IiwidW1hX2F1dGhvcml6YXRpb24iLCJ1c2VyIl19LCJyZXNvdXJjZV9hY2Nlc3MiOnsiYWNjb3VudCI6eyJyb2xlcyI6WyJtYW5hZ2UtYWNjb3VudCIsIm1hbmFnZS1hY2NvdW50LWxpbmtzIiwidmlldy1wcm9maWxlIl19fSwic2NvcGUiOiJlbWFpbCBwcm9maWxlIiwic2lkIjoiODBhYTE5YjEtY2JiNi00OWRhLWI1NjYtNzZjNGYwMWYyNzYzIiwiZW1haWxfdmVyaWZpZWQiOmZhbHNlLCJuYW1lIjoic29tZSB0aGluZyIsInByZWZlcnJlZF91c2VybmFtZSI6InNvbWV0aGluZ0BnbWFpbC5jb20iLCJnaXZlbl9uYW1lIjoic29tZSIsImZhbWlseV9uYW1lIjoidGhpbmciLCJlbWFpbCI6InNvbWV0aGluZ0BnbWFpbC5jb20ifQ.ahcM00oetdgvH9YK0V0SweJ37O73Gp3YB6UMBxTA7RcKyjYUamx6rmdlBxRqEMYcKPpX4fL1ro2wD8GGEAJjTa6mn04bainy7sdM7sY_V4Y9_PsgBOx-8n4XvAIo0yTx_RRfWiDhP_h3r3zxkdtrmjZfI60L8297KxaaCll1GRuGN77r5OwxUSYX_iXRAplHISIbNXFJFo5DEYmP7F-VIzP_8ijnnLaJe-k6qww5fd77rpFOsoYrpMfy9PEtp-aVAMrPtUJciHmAr3fuiDaKhKX0sa6HBObE9CYJEukH9UQqcoHueQcfq0WZu-ffFGVLTcpzwLjCzcPUa8KkmFOJPA">
            <div style="font-size: 12px; color: #999; margin-top: 5px;">T·ª´ Authorization header: Bearer {token}</div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="amount">S·ªë Ti·ªÅn (VND)</label>
                <input type="number" id="amount" value="2000" min="1000" step="1000">
            </div>
            <div class="form-group">
                <label for="description">M√¥ T·∫£</label>
                <input type="text" id="description" value="Mua coins">
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="gateway">Gateway</label>
                <select id="gateway">
                    <option value="SEPAY" selected>SEPAY</option>
                    <option value="PAYOS">PAYOS</option>
                </select>
            </div>
            <div class="form-group">
                <label for="referenceCode">Reference Code (optional)</label>
                <input type="text" id="referenceCode" placeholder="custom-ref-123">
            </div>
        </div>

        <div class="form-group">
            <label for="successUrl">Success URL</label>
            <input type="text" id="successUrl" value="http://localhost:8080/api/payments/callback/success" placeholder="http://localhost:8080/api/payments/callback/success">
        </div>

        <div class="form-group">
            <label for="errorUrl">Error URL</label>
            <input type="text" id="errorUrl" value="http://localhost:8080/api/payments/callback/error" placeholder="http://localhost:8080/api/payments/callback/error">
        </div>

        <div class="form-group">
            <label for="cancelUrl">Cancel URL</label>
            <input type="text" id="cancelUrl" value="http://localhost:8080/api/payments/callback/cancel" placeholder="http://localhost:8080/api/payments/callback/cancel">
        </div>

        <button onclick="createCheckout()" id="submitBtn">
            <span id="btnText">T·∫°o Checkout</span>
        </button>

        <!-- Status Messages -->
        <div class="status" id="statusLoading">
            <h3><span class="loading-spinner"></span>ƒêang x·ª≠ l√Ω...</h3>
        </div>

        <div class="status success" id="statusSuccess">
            <h3>‚úÖ T·∫°o Checkout Th√†nh C√¥ng</h3>
            <div class="status-text">Th√¥ng tin giao d·ªãch c·ªßa b·∫°n:</div>
            <div class="label-info">Transaction ID</div>
            <div class="info-box" id="successTransactionId"></div>
            <div class="label-info">Reference Code</div>
            <div class="info-box" id="successReferenceCode"></div>
            <div class="label-info">Checkout URL</div>
            <div class="info-box" id="successCheckoutUrl"></div>

            <div class="label-info">Gateway</div>
            <div class="info-box" id="successGateway"></div>

            <div class="label-info">Form Fields</div>
            <pre class="info-box" id="successFormFields" style="white-space: pre-wrap;"></pre>

            <div class="actions">
                <button class="btn-link" onclick="submitSepayForm()">V√†o Trang Thanh To√°n</button>
                <button class="btn-secondary" onclick="copyCheckoutUrl()">Copy URL</button>
            </div>
        </div>

        <div class="status error" id="statusError">
            <h3>‚ùå L·ªói</h3>
            <div class="error-message" id="errorMessage"></div>
        </div>

        <!-- Transactions List -->
        <div class="transactions">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3>üìã L·ªãch S·ª≠ Giao D·ªãch</h3>
                <div style="display:flex;gap:10px;align-items:center;">
                    <button class="btn-secondary" onclick="refreshTransactions()" style="width: auto; padding: 8px 16px; font-size: 13px;">Refresh</button>
                    <button class="btn-secondary" onclick="registerBrowserForNotifications()" style="width: auto; padding: 8px 16px; font-size: 13px;">ƒêƒÉng k√Ω Noti (local)</button>
                    <button class="btn-secondary" onclick="sendTestNotification()" style="width: auto; padding: 8px 16px; font-size: 13px;">G·ª≠i noti th·ª≠</button>
                    <button class="btn-secondary" onclick="fetchNotifications()" style="width: auto; padding: 8px 16px; font-size: 13px;">Refresh Noti</button>
                </div>
            </div>
            <div id="transactionsList">
                <p style="color: #999; font-size: 14px;">Ch∆∞a c√≥ giao d·ªãch n√†o</p>
            </div>

            <div style="margin-top:20px;">
                <h3>üîî Th√¥ng b√°o ·ª©ng d·ª•ng</h3>
                <div id="notificationsList" style="min-height:60px;padding:10px;background:#fff;border-radius:6px;border:1px solid #eee;">
                    <p style="color:#999">Ch∆∞a c√≥ th√¥ng b√°o</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentCheckoutData = null;
        let userTransactions = [];

        // Load transactions from localStorage
        function loadTransactions() {
            const stored = localStorage.getItem('sepay_transactions');
            userTransactions = stored ? JSON.parse(stored) : [];
        }

        // Save transactions to localStorage
        function saveTransactions() {
            localStorage.setItem('sepay_transactions', JSON.stringify(userTransactions));
        }

        // Create Checkout
        async function createCheckout() {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const token = document.getElementById('token').value.trim();
            const amount = document.getElementById('amount').value;
            const description = document.getElementById('description').value;
            const successUrl = document.getElementById('successUrl').value;
            const errorUrl = document.getElementById('errorUrl').value;
            const cancelUrl = document.getElementById('cancelUrl').value;
            const gate = (document.getElementById('gateway') && document.getElementById('gateway').value) || 'SEPAY';
            const referenceCode = (document.getElementById('referenceCode') && document.getElementById('referenceCode').value.trim()) || '';

            // Validate
            if (!apiUrl) {
                showError('Vui l√≤ng nh·∫≠p API Base URL');
                return;
            }
            if (!token) {
                showError('Vui l√≤ng nh·∫≠p JWT Token');
                return;
            }
            if (!amount || amount < 1000) {
                showError('S·ªë ti·ªÅn ph·∫£i >= 1000 VND');
                return;
            }

            showLoading();
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;

            try {
                const response = await fetch(`${apiUrl}/checkout/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        amount: parseFloat(amount),
                        description: description || 'Payment',
                        gate: gate,
                        referenceCode: referenceCode || undefined,
                        successUrl: successUrl,
                        errorUrl: errorUrl,
                        cancelUrl: cancelUrl
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP Error: ${response.status}`);
                }

                const data = await response.json();
                const checkout = data.data;

                // Save to localStorage
                currentCheckoutData = {
                    ...checkout,
                    gate: checkout.gate || gate,
                    createdAt: new Date().toLocaleString('vi-VN'),
                    createdAtIso: new Date().toISOString(),
                    amount: parseFloat(amount),
                    description: description
                };

                userTransactions.unshift(currentCheckoutData);
                saveTransactions();
                displayTransactions();

                showSuccess(checkout);

                // Start polling transaction status so FE is updated when backend finalizes
                if (checkout && checkout.transactionId) {
                    pollTransactionUntilFinal(checkout.transactionId).catch(err => {
                        console.warn('Polling error', err);
                    });
                }
            } catch (error) {
                showError(`L·ªói: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
            }
        }

        function showLoading() {
            hideAllStatus();
            document.getElementById('statusLoading').classList.add('show');
        }

        function showSuccess(data) {
            hideAllStatus();
            document.getElementById('successTransactionId').textContent = data.transactionId || 'N/A';
            document.getElementById('successReferenceCode').textContent = data.referenceCode || 'N/A';
            document.getElementById('successCheckoutUrl').textContent = data.checkoutUrl || 'N/A';
            document.getElementById('successGateway').textContent = data.gate || (currentCheckoutData && currentCheckoutData.gate) || 'N/A';

            // Display returned form fields for debugging
            const fieldsJson = JSON.stringify(data.formFields || {}, null, 2);
            document.getElementById('successFormFields').textContent = fieldsJson;

            // Ensure currentCheckoutData contains formFields (some APIs may omit them)
            currentCheckoutData = {
                ...currentCheckoutData,
                formFields: data.formFields || {}
            };

            // show success panel and indicate we'll watch status until final
            document.getElementById('statusSuccess').classList.add('show');
            const infoBox = document.getElementById('successCheckoutUrl');
            if (currentCheckoutData && currentCheckoutData.transactionId) {
                infoBox.insertAdjacentHTML('afterend', "<div style='margin-top:8px;color:#666;font-size:13px;'>ƒêang ch·ªù x√°c nh·∫≠n t·ª´ server ‚Äî s·∫Ω t·ª± c·∫≠p nh·∫≠t tr·∫°ng th√°i.</div>");
            }
        }

        function showError(message) {
            hideAllStatus();
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('statusError').classList.add('show');
        }

        function hideAllStatus() {
            document.getElementById('statusLoading').classList.remove('show');
            document.getElementById('statusSuccess').classList.remove('show');
            document.getElementById('statusError').classList.remove('show');
        }

        function submitSepayForm() {
            if (!currentCheckoutData || !currentCheckoutData.checkoutUrl) {
                alert('Kh√¥ng c√≥ checkout URL ƒë·ªÉ g·ª≠i m·∫´u.');
                return;
            }

            // If gateway is PayOS, open the checkout URL directly (PayOS returns a link)
            if (currentCheckoutData.gate === 'PAYOS') {
                window.open(currentCheckoutData.checkoutUrl, '_blank');
                return;
            }

            const formFields = currentCheckoutData.formFields || {};

            // If no form fields were returned, fallback to opening the URL in a new tab
            if (!formFields || Object.keys(formFields).length === 0) {
                if (confirm('Kh√¥ng c√≥ form fields tr·∫£ v·ªÅ. M·ªü URL b·∫±ng GET c√≥ th·ªÉ tr·∫£ v·ªÅ 404. M·ªü b·∫±ng tr√¨nh duy·ªát?')) {
                    window.open(currentCheckoutData.checkoutUrl, '_blank');
                }
                return;
            }

            const form = document.createElement('form');
            form.method = 'POST';
            form.action = currentCheckoutData.checkoutUrl;
            form.style.display = 'none';
            form.acceptCharset = 'UTF-8';

            // Open the POST result in a new tab
            form.target = '_blank';

            Object.keys(formFields).forEach(key => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = formFields[key] == null ? '' : String(formFields[key]);
                form.appendChild(input);
            });

            document.body.appendChild(form);
            form.submit();
        }

        function copyCheckoutUrl() {
            if (currentCheckoutData && currentCheckoutData.checkoutUrl) {
                navigator.clipboard.writeText(currentCheckoutData.checkoutUrl).then(() => {
                    alert('‚úÖ ƒê√£ copy URL!');
                }).catch(() => {
                    alert('‚ùå L·ªói copy URL');
                });
            }
        }

        function displayTransactions() {
            const listDiv = document.getElementById('transactionsList');
            if (userTransactions.length === 0) {
                listDiv.innerHTML = '<p style="color: #999; font-size: 14px;">Ch∆∞a c√≥ giao d·ªãch n√†o</p>';
                return;
            }

            // Sort by timestamp (ISO if available) descending and limit to 10 most recent
            const sorted = userTransactions.slice().sort((a, b) => {
                const aTime = new Date(a.createdAtIso || a.createdAt).getTime();
                const bTime = new Date(b.createdAtIso || b.createdAt).getTime();
                return bTime - aTime;
            });

            const limited = sorted.slice(0, 10);

            listDiv.innerHTML = limited.map(tx => `
                <div class="transaction-item">
                    <div class="transaction-header">
                        <div class="transaction-id">${tx.transactionId ? tx.transactionId.substring(0, 12) + '...' : '‚Äî'} <span class="info-tag">${tx.gate || 'SEPAY'}</span></div>
                        <span class="transaction-status ${tx.status?.toLowerCase() || 'pending'}">${tx.status || 'PENDING'}</span>
                    </div>
                    <div class="transaction-info">
                        <strong>S·ªë ti·ªÅn:</strong> ${tx.amount?.toLocaleString('vi-VN')} VND
                    </div>
                    <div class="transaction-info">
                        <strong>M√¥ t·∫£:</strong> ${tx.description}
                    </div>
                    <div class="transaction-info">
                        <strong>Th·ªùi gian:</strong> ${tx.createdAt}
                    </div>
                    <div class="transaction-info">
                        <strong>Reference Code:</strong> <span style="font-family: monospace; background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">${tx.referenceCode}</span>
                    </div>
                    <div class="actions" style="margin-top: 10px;">
                        <button class="btn-secondary" onclick="getTransactionStatus('${tx.transactionId}')" style="flex: 1; font-size: 12px; padding: 8px;">
                            Ki·ªÉm Tra Tr·∫°ng Th√°i
                        </button>
                        <button class="btn-secondary" onclick="openCheckoutUrl('${tx.checkoutUrl}')" style="flex: 1; font-size: 12px; padding: 8px;">
                            V√†o Thanh To√°n
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function getTransactionStatus(transactionId) {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const token = document.getElementById('token').value.trim();

            if (!token) {
                alert('Vui l√≤ng nh·∫≠p JWT Token');
                return;
            }

            try {
                const response = await fetch(`${apiUrl}/transaction/${transactionId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status}`);
                }

                const data = await response.json();
                const transaction = data.data;

                // Update local transaction
                const idx = userTransactions.findIndex(t => t.transactionId === transactionId);
                if (idx !== -1) {
                    userTransactions[idx].status = transaction.status;
                    saveTransactions();
                    displayTransactions();
                }

                alert(`‚úÖ Tr·∫°ng th√°i: ${transaction.status}\n\nNg√†y t·∫°o: ${transaction.createdAt}\nNg√†y ho√†n th√†nh: ${transaction.completedAt || 'Ch∆∞a'}`);
            } catch (error) {
                alert(`‚ùå L·ªói: ${error.message}`);
            }
        }

        // Poll transaction status until final (COMPLETED / FAILED / CANCELLED / REFUNDED) or timeout
        async function pollTransactionUntilFinal(transactionId, timeoutMs = 180000, intervalMs = 2000) {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const token = document.getElementById('token').value.trim();
            if (!apiUrl || !token) return;

            const deadline = Date.now() + timeoutMs;
            while (Date.now() < deadline) {
                try {
                    const res = await fetch(`${apiUrl}/transaction/${transactionId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    const json = await res.json();
                    const tx = json.data;

                    // update local storage/UI
                    const idx = userTransactions.findIndex(t => t.transactionId === transactionId);
                    if (idx !== -1) {
                        userTransactions[idx].status = tx.status;
                        saveTransactions();
                        displayTransactions();
                    }

                    // If final state, show appropriate message and stop polling
                    if (tx.status && tx.status !== 'PENDING' && tx.status !== 'PROCESSING') {
                        if (tx.status === 'COMPLETED') {
                            alert('‚úÖ Giao d·ªãch ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n ‚Äî coin ƒë√£ c·ªông.');
                        } else if (tx.status === 'REFUNDED') {
                            alert('‚ÑπÔ∏è Giao d·ªãch v·∫´n PENDING sau retry ‚Äî ƒë√£ ho√†n ti·ªÅn (REFUNDED).');
                        } else if (tx.status === 'CANCELLED') {
                            alert('‚ÑπÔ∏è Giao d·ªãch b·ªã hu·ª∑.');
                        } else if (tx.status === 'FAILED') {
                            alert('‚ùå Giao d·ªãch th·∫•t b·∫°i. Li√™n h·ªá h·ªó tr·ª£.');
                        }
                        return tx;
                    }
                } catch (err) {
                    console.warn('poll error', err);
                    // continue until timeout
                }

                await new Promise(r => setTimeout(r, intervalMs));
            }

            console.warn('pollTransactionUntilFinal: timeout for', transactionId);
            return null;
        }

        function openCheckoutUrl(url) {
            window.open(url, '_blank');
        }

        async function refreshTransactions() {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const token = document.getElementById('token').value.trim();

            if (!token) {
                alert('Vui l√≤ng nh·∫≠p JWT Token');
                return;
            }

            try {
                const response = await fetch(`${apiUrl}/user/transactions?page=1&size=20`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status}`);
                }

                const data = await response.json();
                const transactions = data.data.data;

                userTransactions = transactions.map(tx => ({
                    transactionId: tx.id,
                    referenceCode: tx.referenceCode,
                    checkoutUrl: '', // Not available from API
                    status: tx.status,
                    gate: tx.gate,
                    amount: tx.amount,
                    description: tx.description,
                    createdAt: tx.createdAt,
                    createdAtIso: tx.createdAt, // expect ISO from API
                    completedAt: tx.completedAt
                }));

                saveTransactions();
                displayTransactions();
                alert('‚úÖ Refresh th√†nh c√¥ng!');
            } catch (error) {
                alert(`‚ùå L·ªói: ${error.message}`);
            }
        }

        // Load transactions on page load
        window.addEventListener('load', () => {
            loadTransactions();
            displayTransactions();
            // fetch user's app notifications (if any)
            fetchNotifications().catch(() => {});
        });

        // Helper: derive API root from the configured payments API URL
        function apiRoot() {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            // remove any path after /api (e.g. /api/payments)
            return apiUrl.replace(/\/api\/.*$/,'') || apiUrl;
        }

        async function registerBrowserForNotifications() {
            const api = apiRoot();
            const token = document.getElementById('token').value.trim();
            if (!token) { alert('Vui l√≤ng nh·∫≠p JWT Token'); return; }

            // ask for Notification permission (for UX) ‚Äî not required for server-side app notifications
            if (Notification && Notification.permission !== 'granted') {
                try { await Notification.requestPermission(); } catch (e) { /* ignore */ }
            }

            const fakeToken = 'web-local-' + Math.random().toString(36).slice(2, 10);
            try {
                const res = await fetch(`${api}/api/notifications/device`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ token: fakeToken })
                });
                if (!res.ok) throw new Error('ƒêƒÉng k√Ω th·∫•t b·∫°i');
                alert('‚úÖ ƒê√£ ƒëƒÉng k√Ω thi·∫øt b·ªã (local token)');
            } catch (err) {
                alert('‚ùå L·ªói ƒëƒÉng k√Ω device: ' + err.message);
            }
        }

        async function sendTestNotification() {
            const api = apiRoot();
            const token = document.getElementById('token').value.trim();
            if (!token) { alert('Vui l√≤ng nh·∫≠p JWT Token'); return; }

            try {
                const res = await fetch(`${api}/api/notifications/send-me`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ title: 'Test th√¥ng b√°o', body: 'Th√¥ng b√°o th·ª≠ t·ª´ payment-test.html' })
                });
                if (!res.ok) throw new Error('Kh√¥ng th·ªÉ g·ª≠i th√¥ng b√°o');
                alert('‚úÖ Th√¥ng b√°o ƒë√£ ƒë∆∞·ª£c t·∫°o (in-app). Ki·ªÉm tra danh s√°ch th√¥ng b√°o.');
                await fetchNotifications();
            } catch (err) {
                alert('‚ùå L·ªói g·ª≠i noti: ' + err.message);
            }
        }

        async function fetchNotifications() {
            const api = apiRoot();
            const token = document.getElementById('token').value.trim();
            if (!token) { return; }
            try {
                const res = await fetch(`${api}/api/notifications?page=0&size=10`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('Fetch notifications failed');
                const json = await res.json();
                const list = json.data.data || [];
                const container = document.getElementById('notificationsList');
                if (!list.length) {
                    container.innerHTML = '<p style="color:#999">Ch∆∞a c√≥ th√¥ng b√°o</p>';
                    return;
                }
                container.innerHTML = list.map(n => `
                    <div style="padding:8px;border-bottom:1px solid #f0f0f0;">
                        <div style="font-weight:600">${n.title}</div>
                        <div style="font-size:13px;color:#555;margin-top:4px">${n.body || ''}</div>
                        <div style="font-size:11px;color:#999;margin-top:6px">${new Date(n.createdAt).toLocaleString()}</div>
                    </div>
                `).join('');
            } catch (err) {
                console.warn('fetchNotifications error', err);
            }
        }
    </script>
</body>
</html>
