services:
  config-server:
    image: datn/config-server
    container_name: config-server
    deploy:
      resources:
        limits:
          memory: 512M
    environment:
      - GIT_USERNAME=${GIT_USERNAME}
      - GIT_TOKEN=${GIT_TOKEN}
      - CONFIG_REPO_URL=${CONFIG_REPO_URL}
      - EUREKA_URI=${EUREKA_URI}
    healthcheck:
      test: [ "CMD", "curl", "-I", "http://config-server:8888" ]
      interval: 5s
      timeout: 5s
      retries: 10
    ports:
      - 8888:8888

  discovery-service:
    image: datn/discovery-service
    container_name: discovery-service
    deploy:
      resources:
        limits:
          memory: 512M
    environment:
      - SPRING_CONFIG_IMPORT=configserver:http://config-server:8888
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://discovery-service:8761" ]
      interval: 5s
      timeout: 3s
      retries: 10
    depends_on:
      config-server:
        condition: service_healthy
    ports:
      - 8761:8761

  admin-server:
    image: datn/admin-server
    container_name: admin-server
    deploy:
      resources:
        limits:
          memory: 512M
    environment:
      - SPRING_CONFIG_IMPORT=configserver:http://config-server:8888
      - EUREKA_URI
    depends_on:
      config-server:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
    ports:
      - 9090:9090

  auth:
    image: datn/auth
    container_name: auth
    deploy:
      resources:
        limits:
          memory: 512M
    environment:
      - SPRING_CONFIG_IMPORT=configserver:http://config-server:8888
      - AUTH_DB_URL
      - AUTH_DB_USERNAME
      - AUTH_DB_PASSWORD
      - EUREKA_URI
    depends_on:
      config-server:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
    ports:
      - 8081:8081

  document-service:
    image: datn/document-service
    container_name: document-service
    deploy:
      resources:
        limits:
          memory: 512M
    depends_on:
      config-server:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
    ports:
      - 8082:8082

  api-gateway:
    image: datn/api-gateway
    container_name: api-gateway
    deploy:
      resources:
        limits:
          memory: 512M
    depends_on:
      config-server:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
    ports:
      - 8080:8080
    environment:
      - ALLOWED_ORIGINS
      - SPRING_CONFIG_IMPORT=configserver:http://config-server:8888
      - EUREKA_URI

  ai-service:
    image: datn/ai-service
    container_name: ai-service
    environment:
      - SPRING_CONFIG_IMPORT=configserver:http://config-server:8888
      - EUREKA_URI
      - OPENAI_KEY
      - MODEL_CONFIG_DB_URL
      - MODEL_CONFIG_DB_USERNAME
      - MODEL_CONFIG_DB_PASSWORD
      - GOOGLE_APPLICATION_CREDENTIALS=/secrets/key.json
      - VERTEX_PROJECT_ID
      - VERTEX_LOCATION
      - RABBITMQ_HOST
      - RABBITMQ_PORT
      - RABBITMQ_USERNAME
      - RABBITMQ_PASSWORD
    volumes:
      - ${VERTEX_SERVICE_ACCOUNT_KEY_PATH}:/secrets/key.json:ro
    depends_on:
      config-server:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
    restart: on-failure
    ports:
      - 8083:8083