<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Google OAuth2 Login Test - DATN Backend</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
            'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans',
            'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .section {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 1px solid #eee;
        }

        .section:last-child {
            border-bottom: none;
        }

        .section h2 {
            color: #667eea;
            font-size: 16px;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .config-item {
            display: flex;
            flex-direction: column;
        }

        .config-item label {
            color: #555;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .config-item input,
        .config-item select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 13px;
            font-family: monospace;
            background: #f9f9f9;
        }

        .config-item input:focus,
        .config-item select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            grid-column: 1 / -1;
        }

        .btn-primary:hover {
            background: #5568d3;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-danger {
            background: #ff6b6b;
            color: white;
            grid-column: 1 / -1;
        }

        .btn-danger:hover {
            background: #ee5a52;
        }

        .btn-success {
            background: #51cf66;
            color: white;
        }

        .btn-success:hover {
            background: #40c057;
        }

        .alert {
            padding: 12px 15px;
            border-radius: 5px;
            font-size: 13px;
            margin-bottom: 15px;
            word-break: break-all;
        }

        .alert-info {
            background: #e7f5ff;
            color: #1971c2;
            border: 1px solid #74c0fc;
        }

        .alert-success {
            background: #e6fcf5;
            color: #0a7e6b;
            border: 1px solid #7fdbca;
        }

        .alert-error {
            background: #ffe0e6;
            color: #c92a2a;
            border: 1px solid #ffa8b8;
        }

        .token-display {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            white-space: pre-wrap;
        }

        .token-label {
            font-size: 11px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .copy-btn {
            padding: 5px 10px;
            font-size: 11px;
            margin-top: 10px;
        }

        .step-indicator {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 600;
            color: #999;
        }

        .step.active {
            background: #667eea;
            color: white;
        }

        .info-box {
            background: #f9f9f9;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 3px;
            font-size: 13px;
            color: #555;
        }

        .info-box code {
            background: #e9ecef;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 11px;
        }

        .flow-diagram {
            background: #f5f5f5;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 12px;
            font-family: monospace;
            color: #666;
            line-height: 1.6;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 22px;
            }

            .config-grid {
                grid-template-columns: 1fr;
            }

            .button-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>üîê Google OAuth2 Login Test</h1>
    <p class="subtitle">DATN Backend - Google Login (Hidden Keycloak)</p>

    <!-- Step Indicator -->
    <div class="step-indicator">
        <div class="step active" id="step1">1. Configure</div>
        <div class="step" id="step2">2. Google Auth</div>
        <div class="step" id="step3">3. Exchange</div>
        <div class="step" id="step4">4. Token</div>
    </div>

    <!-- Configuration Section -->
    <div class="section">
        <h2>‚öôÔ∏è Configuration</h2>
        <div class="flow-diagram">
            1. User clicks "Login with Google"<br>
            2. Frontend calls Backend: GET /api/auth/google/signin<br>
            3. Backend returns Google login URL (via Keycloak)<br>
            4. Frontend redirects to Google (NO Keycloak API exposed)<br>
            5. User authenticates with Gmail<br>
            6. Google redirects to frontend with code<br>
            7. Frontend POST code to /api/auth/exchange<br>
            8. Backend exchanges code with Keycloak for tokens
        </div>

        <div class="info-box">
            <strong>‚úÖ Simple Setup - All Keycloak details hidden:</strong>
            <ul style="margin-top: 10px; margin-left: 20px;">
                <li>Frontend only needs Backend URL</li>
                <li>Frontend only needs To Redirect URI (where you are now)</li>
                <li>All Keycloak configuration is on the backend</li>
                <li>Backend handles all Keycloak API calls</li>
            </ul>
        </div>

        <div class="config-grid">
            <div class="config-item full-width">
                <label>Backend URL</label>
                <input id="backendUrl" placeholder="http://localhost:8080" type="text" value="http://localhost:8080">
            </div>
            <div class="config-item full-width">
                <label>Frontend Redirect URI (where you are now)</label>
                <input id="redirectUri" placeholder="http://localhost:3000" type="text" value="http://localhost:3000">
            </div>
        </div>

        <button class="btn-secondary" onclick="loadStoredConfig()">‚ü≤ Load Stored Config</button>
        <button class="btn-secondary" onclick="saveConfig()">üíæ Save Config</button>
    </div>

    <!-- OAuth Flow Section -->
    <div class="section">
        <h2>üîÑ Google Login Flow</h2>
        <div class="info-box">
            Click the button below to start the Google login flow. You will be redirected to Google, authenticate, and
            then the authorization code will be automatically processed.
        </div>

        <div id="statusMessage"></div>

        <div class="button-group">
            <button class="btn-primary" onclick="startGoogleLogin()">
                ÔøΩ Login with Google
            </button>
        </div>

        <div id="authUrlDisplay"></div>
    </div>

    <!-- Token Exchange Section -->
    <div class="section">
        <h2>ÔøΩ Results</h2>
        <div id="statusMessage2"></div>

        <div id="accessTokenSection" style="display: none;">
            <div class="token-label">Access Token</div>
            <div class="token-display" id="accessTokenDisplay"></div>
            <button class="btn-secondary copy-btn" onclick="copyToClipboard('accessTokenDisplay')">
                üìã Copy Access Token
            </button>
            <button class="btn-secondary copy-btn" onclick="decodeToken('accessTokenDisplay')">
                üîç Decode Access Token
            </button>
        </div>

            <div id="refreshTokenSection" style="display: none;">
                <div class="token-label">Refresh Token</div>
                <div class="token-display" id="refreshTokenDisplay"></div>
                <button class="btn-secondary copy-btn" onclick="copyToClipboard('refreshTokenDisplay')">
                    üìã Copy Refresh Token
                </button>
            </div>

            <div id="cookieSection" style="display: none;">
                <div class="token-label">üç™ Cookies (HttpOnly)</div>
                <div class="token-display" id="cookieDisplay"></div>
                <div class="alert alert-info" style="margin-top: 10px;">
                    ‚ÑπÔ∏è Tokens are stored as HttpOnly cookies by the backend. They should NOT be visible here (security feature).
                    If you see them above, cookies are readable (consider enabling HttpOnly flag).
                </div>
            </div>        <div id="tokenInfoSection" style="display: none;">
            <div class="token-label">Token Information</div>
            <div class="token-display" id="tokenInfoDisplay"></div>
        </div>

        <div id="decodedTokenSection" style="display: none;">
            <div class="token-label">Decoded Token Payload</div>
            <div class="token-display" id="decodedTokenDisplay"></div>
        </div>

        <button class="btn-danger" id="clearBtn" onclick="clearResults()" style="display: none;">
            üóëÔ∏è Clear All Results
        </button>
    </div>

        <!-- Testing Section -->
        <div class="section">
            <h2>üß™ API Testing (with Cookie Token)</h2>
            <div class="info-box">
                ‚úÖ Tokens are sent automatically via cookies (credentials: 'include').<br>
                Backend uses CookieBearerTokenResolver to extract tokens from access_token cookie.<br>
                <strong>No Authorization header needed!</strong>
            </div>        <div class="config-grid">
            <div class="config-item full-width">
                <label>API Endpoint</label>
                <input id="apiEndpoint" placeholder="/api/user/profile" type="text" value="/api/user/profile">
            </div>
        </div>

        <div class="button-group">
            <button class="btn-success" onclick="testApiWithToken('GET')">GET</button>
            <button class="btn-success" onclick="testApiWithToken('POST')">POST</button>
        </div>

        <div id="apiResultSection" style="display: none;">
            <div class="token-label">API Response</div>
            <div class="token-display" id="apiResultDisplay"></div>
        </div>
    </div>
</div>

<script>
    // Configuration Management
    function saveConfig() {
        const config = {
            backendUrl: document.getElementById('backendUrl').value,
            redirectUri: document.getElementById('redirectUri').value,
        };
        localStorage.setItem('oauthConfig', JSON.stringify(config));
        showStatus('‚úÖ Configuration saved to localStorage', 'success');
    }

    function loadStoredConfig() {
        const stored = localStorage.getItem('oauthConfig');
        if (stored) {
            const config = JSON.parse(stored);
            document.getElementById('backendUrl').value = config.backendUrl || '';
            document.getElementById('redirectUri').value = config.redirectUri || '';
            showStatus('‚úÖ Configuration loaded from localStorage', 'success');
        } else {
            showStatus('‚ö†Ô∏è No stored configuration found', 'info');
        }
    }

    function getConfig() {
        return {
            backendUrl: document.getElementById('backendUrl').value.trim(),
            redirectUri: document.getElementById('redirectUri').value.trim(),
        };
    }

    // OAuth2 Flow - Via Backend (Keycloak hidden)
    function startGoogleLogin() {
        const config = getConfig();
        if (!config.backendUrl || !config.redirectUri) {
            showStatus('‚ùå Please fill in all required configuration fields', 'error');
            return;
        }

        showStatus('‚è≥ Getting Google login URL from backend...', 'info');
        updateStep(2);

        // Call backend to get Google login URL
        fetch(`${config.backendUrl}/api/auth/google/signin?redirectUri=${encodeURIComponent(config.redirectUri)}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.message) {
                    console.log('Redirecting to Google via backend:', data.message);
                    showStatus('‚úÖ Redirecting to Google...', 'success');
                    window.location.href = data.message;
                } else {
                    showStatus(`‚ùå Backend error: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showStatus(`‚ùå Error: ${error.message}`, 'error');
            });
    }

    // Token Exchange
    function manualExchangeCode() {
        const code = document.getElementById('authCode').value.trim();
        if (!code) {
            showStatus('‚ùå Please enter an authorization code', 'error');
            return;
        }

        const config = getConfig();
        exchangeCodeForTokens(code, config);
    }

    function exchangeCodeForTokens(code, config) {
        const request = {
            code: code,
            redirectUri: config.redirectUri,
        };

        showStatus('‚è≥ Exchanging authorization code for tokens...', 'info');
        updateStep(3);

        fetch(`${config.backendUrl}/api/auth/exchange`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(request),
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(`HTTP ${response.status}: ${err.message || response.statusText}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.data) {
                    displayTokens(data.data);
                    updateStep(4);
                    showStatus('‚úÖ Tokens received successfully!', 'success');
                } else {
                    showStatus(`‚ùå Token exchange failed: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showStatus(`‚ùå Error: ${error.message}`, 'error');
            });
    }

        function displayTokens(tokenData) {
            // Access Token
            document.getElementById('accessTokenSection').style.display = 'block';
            document.getElementById('accessTokenDisplay').textContent = tokenData.accessToken || 'N/A';

            // Refresh Token
            if (tokenData.refreshToken) {
                document.getElementById('refreshTokenSection').style.display = 'block';
                document.getElementById('refreshTokenDisplay').textContent = tokenData.refreshToken;
            }

            // Token Info
            document.getElementById('tokenInfoSection').style.display = 'block';
            const tokenInfo = `
Token Type: ${tokenData.tokenType || 'Bearer'}
Expires In: ${tokenData.expiresIn || 'N/A'} seconds
Expires At: ${new Date(Date.now() + (tokenData.expiresIn || 0) * 1000).toLocaleString()}
Timestamp: ${new Date().toLocaleString()}
            `.trim();
            document.getElementById('tokenInfoDisplay').textContent = tokenInfo;

            // Check cookies
            setTimeout(() => {
                const cookies = document.cookie.split(';').reduce((acc, cookie) => {
                    const [name, value] = cookie.trim().split('=');
                    acc[name] = value;
                    return acc;
                }, {});

                if (cookies.access_token || cookies.refresh_token) {
                    document.getElementById('cookieSection').style.display = 'block';
                    let cookieInfo = '‚úÖ Tokens stored in cookies:\n';
                    if (cookies.access_token) {
                        cookieInfo += `\naccess_token: ${decodeURIComponent(cookies.access_token).substring(0, 50)}...`;
                    }
                    if (cookies.refresh_token) {
                        cookieInfo += `\nrefresh_token: ${decodeURIComponent(cookies.refresh_token).substring(0, 50)}...`;
                    }
                    document.getElementById('cookieDisplay').textContent = cookieInfo;
                } else {
                    document.getElementById('cookieSection').style.display = 'block';
                    document.getElementById('cookieDisplay').textContent = '‚ö†Ô∏è Tokens NOT found in cookies\n(Check if cookies are being set by the backend)';
                }
            }, 100);

            // Show clear button
            document.getElementById('clearBtn').style.display = 'block';

            // Store tokens in sessionStorage as backup
            sessionStorage.setItem('accessToken', tokenData.accessToken);
            sessionStorage.setItem('refreshToken', tokenData.refreshToken || '');
            sessionStorage.setItem('tokenExpiry', Date.now() + (tokenData.expiresIn || 0) * 1000);
        }    // Token Utilities
    function decodeToken(elementId) {
        const tokenText = document.getElementById(elementId).textContent;
        if (!tokenText || tokenText === 'N/A') {
            showStatus('‚ùå No token to decode', 'error');
            return;
        }

        try {
            const parts = tokenText.split('.');
            if (parts.length !== 3) {
                throw new Error('Invalid JWT format');
            }

            const decoded = JSON.parse(atob(parts[1]));
            document.getElementById('decodedTokenSection').style.display = 'block';
            document.getElementById('decodedTokenDisplay').textContent = JSON.stringify(decoded, null, 2);
            showStatus('‚úÖ Token decoded successfully', 'success');
        } catch (error) {
            showStatus(`‚ùå Error decoding token: ${error.message}`, 'error');
        }
    }

    function copyToClipboard(elementId) {
        const text = document.getElementById(elementId).textContent;
        navigator.clipboard.writeText(text).then(() => {
            showStatus('‚úÖ Copied to clipboard', 'success');
        }).catch(() => {
            showStatus('‚ùå Failed to copy to clipboard', 'error');
        });
    }

    function copyText(text) {
        navigator.clipboard.writeText(text).then(() => {
            showStatus('‚úÖ Copied to clipboard', 'success');
        }).catch(() => {
            showStatus('‚ùå Failed to copy to clipboard', 'error');
        });
    }

        // API Testing
        function testApiWithToken(method) {
            const config = getConfig();
            const endpoint = document.getElementById('apiEndpoint').value.trim();
            const url = `${config.backendUrl}${endpoint}`;

            showStatus(`‚è≥ Testing ${method} ${endpoint}...`, 'info');

            // Note: Cookies are sent automatically by the browser
            // The backend will use CookieBearerTokenResolver to extract the token from cookies
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include',  // Important: Send cookies with request
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('apiResultSection').style.display = 'block';
                document.getElementById('apiResultDisplay').textContent = JSON.stringify(data, null, 2);
                showStatus(`‚úÖ API response received (token from cookies)`, 'success');
            })
            .catch(error => {
                document.getElementById('apiResultSection').style.display = 'block';
                document.getElementById('apiResultDisplay').textContent = `Error: ${error.message}`;
                showStatus(`‚ùå API Error: ${error.message}`, 'error');
            });
        }    // UI Utilities
    function showStatus(message, type) {
        const msgDiv = document.getElementById('statusMessage');
        const className = `alert alert-${type}`;
        msgDiv.innerHTML = `<div class="${className}">${message}</div>`;
        console.log(`[${type.toUpperCase()}] ${message}`);
    }

        function clearResults() {
            document.getElementById('accessTokenSection').style.display = 'none';
            document.getElementById('refreshTokenSection').style.display = 'none';
            document.getElementById('tokenInfoSection').style.display = 'none';
            document.getElementById('cookieSection').style.display = 'none';
            document.getElementById('decodedTokenSection').style.display = 'none';
            document.getElementById('apiResultSection').style.display = 'none';
            document.getElementById('statusMessage').innerHTML = '';
            document.getElementById('authCode').value = '';
            document.getElementById('clearBtn').style.display = 'none';
            document.getElementById('authUrlDisplay').innerHTML = '';
            updateStep(1);
            showStatus('‚úÖ All results cleared', 'success');
        }    function updateStep(step) {
        for (let i = 1; i <= 4; i++) {
            const stepEl = document.getElementById(`step${i}`);
            if (i <= step) {
                stepEl.classList.add('active');
            } else {
                stepEl.classList.remove('active');
            }
        }
    }

    function generateState() {
        return Math.random().toString(36).substring(2, 15) +
            Math.random().toString(36).substring(2, 15);
    }

    // Check for authorization code in URL (callback from Keycloak)
    function handleCallback() {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state');

        if (code) {
            console.log('Authorization code received from Google:', code);
            showStatus('‚úÖ Authorization code received from Google! Exchanging for tokens...', 'success');
            updateStep(3);

            // Clean up URL
            window.history.replaceState({}, document.title, window.location.pathname);

            // Auto-exchange code for tokens
            const config = getConfig();
            exchangeCodeForTokens(code, config);
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        loadStoredConfig();
        handleCallback();
    });
</script>
</body>
</html>
